
window.noUiSlider = {
  create: function(element, options) {
    const base = document.createElement('div');
    base.className = 'noUi-base';
    element.appendChild(base);

    const connect = document.createElement('div');
    connect.className = 'noUi-connect';
    base.appendChild(connect);

    const handle = document.createElement('div');
    handle.className = 'noUi-handle';
    base.appendChild(handle);

    const currentOptions = Object.assign({
      range: { min: 0, max: 100 },
      start: 50,
      step: 1,
      connect: 'lower'
    }, options || {});

    const listeners = {};

    const percentageToValue = (percentage) => {
      const range = currentOptions.range;
      return range.min + (percentage / 100) * (range.max - range.min);
    };

    const valueToPercentage = (value) => {
      const range = currentOptions.range;
      return ((value - range.min) / (range.max - range.min)) * 100;
    };

    const updatePosition = (percentage) => {
      percentage = Math.max(0, Math.min(100, percentage));

      connect.style.width = `${percentage}%`;
      handle.style.left = `${percentage}%`;

      let value = percentageToValue(percentage);

      if (currentOptions.step > 0) {
        value = Math.round(value / currentOptions.step) * currentOptions.step;
        const newPercentage = valueToPercentage(value);
        connect.style.width = `${newPercentage}%`;
        handle.style.left = `${newPercentage}%`;
      }

      if (listeners.update) {
        listeners.update.forEach((callback) => {
          callback([value]);
        });
      }

      return value;
    };

    const handleClick = (e) => {
      const rect = element.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const percentage = (x / rect.width) * 100;

      updatePosition(percentage);
    };

    const startDrag = (e) => {
      e.preventDefault();
      const startX = e.clientX || e.touches[0].clientX;
      const startLeft = parseFloat(handle.style.left) || 0;

      const onMouseMove = (moveEvent) => {
        const clientX = moveEvent.clientX || (moveEvent.touches && moveEvent.touches[0].clientX);
        if (!clientX) {
          return;
        }

        const rect = element.getBoundingClientRect();
        const deltaX = clientX - startX;
        const deltaPercent = (deltaX / rect.width) * 100;
        const newPercentage = startLeft + deltaPercent;

        updatePosition(newPercentage);
      };

      const onMouseUp = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      };

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    };

    const initialStartValue = Array.isArray(currentOptions.start) ? currentOptions.start[0] : currentOptions.start;
    const initialPercentage = valueToPercentage(initialStartValue);
    updatePosition(initialPercentage);

    element.addEventListener('click', handleClick);
    handle.addEventListener('mousedown', startDrag);
    handle.addEventListener('touchstart', startDrag);

    const slider = {
      updateOptions: function(newOptions) {
        Object.assign(currentOptions, newOptions);

        if (newOptions.start !== undefined) {
          const newStartValue = Array.isArray(newOptions.start) ? newOptions.start[0] : newOptions.start;
          const newPercentage = valueToPercentage(newStartValue);
          updatePosition(newPercentage);
        }

        return this;
      },

      on: function(event, callback) {
        if (!listeners[event]) {
          listeners[event] = [];
        }
        listeners[event].push(callback);
        return this;
      },

      destroy: function() {
        element.removeEventListener('click', handleClick);
        handle.removeEventListener('mousedown', startDrag);
        handle.removeEventListener('touchstart', startDrag);

        element.innerHTML = '';
      },

      get: function() {
        return [percentageToValue(parseFloat(handle.style.left) || 0)];
      },

      set: function(value) {
        const val = Array.isArray(value) ? value[0] : value;
        const percentage = valueToPercentage(val);
        updatePosition(percentage);
      }
    };

    element.noUiSlider = slider;

    return slider;
  }
};
