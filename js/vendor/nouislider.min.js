
(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.noUiSlider = factory());
})(this, (function () { 'use strict';

  var noUiSlider = {
    create: function create(element, options) {
      console.log('noUiSlider создается для элемента:', element);

      element.innerHTML = '';

      var base = document.createElement('div');
      base.className = 'noUi-base';
      element.appendChild(base);

      var connects = document.createElement('div');
      connects.className = 'noUi-connects';
      base.appendChild(connects);

      var connect = document.createElement('div');
      connect.className = 'noUi-connect';
      connects.appendChild(connect);

      var handles = document.createElement('div');
      handles.className = 'noUi-origin';
      base.appendChild(handles);

      var handle = document.createElement('div');
      handle.className = 'noUi-handle';
      handle.setAttribute('tabindex', '0');
      handle.setAttribute('role', 'slider');
      handles.appendChild(handle);

      var touchArea = document.createElement('div');
      touchArea.className = 'noUi-touch-area';
      handle.appendChild(touchArea);

      var currentOptions = Object.assign({
        range: { min: 0, max: 100 },
        start: 50,
        step: 1,
        connect: 'lower',
        orientation: 'horizontal',
        direction: 'ltr'
      }, options || {});

      var isDragging = false;
      var startX = 0;
      var startLeft = 0;
      var currentPercentage = 50;
      var listeners = {};

      function percentageToValue(percentage) {
        var range = currentOptions.range;
        return range.min + (percentage / 100) * (range.max - range.min);
      }

      function valueToPercentage(value) {
        var range = currentOptions.range;
        return ((value - range.min) / (range.max - range.min)) * 100;
      }

      function updatePosition(percentage) {
        percentage = Math.max(0, Math.min(100, percentage));
        currentPercentage = percentage;

        connect.style.width = percentage + '%';
        handles.style.left = percentage + '%';

        var value = percentageToValue(percentage);

        if (currentOptions.step > 0) {
          value = Math.round(value / currentOptions.step) * currentOptions.step;
          percentage = valueToPercentage(value);
          connect.style.width = percentage + '%';
          handles.style.left = percentage + '%';
        }

        handle.setAttribute('aria-valuenow', value.toFixed(1));
        handle.setAttribute('aria-valuemin', currentOptions.range.min);
        handle.setAttribute('aria-valuemax', currentOptions.range.max);

        triggerEvent('update', [value]);

        return value;
      }

      function triggerEvent(event, args) {
        if (listeners[event]) {
          listeners[event].forEach(function(callback) {
            callback.call(null, args);
          });
        }
      }

      function handleClick(e) {
        if (isDragging) return;

        var rect = element.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var percentage = (x / rect.width) * 100;

        updatePosition(percentage);
        triggerEvent('set', [percentageToValue(currentPercentage)]);
      }

      function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX || e.touches[0].clientX;
        startLeft = currentPercentage;

        triggerEvent('start', [percentageToValue(currentPercentage)]);

        handle.classList.add('noUi-active');

        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchmove', handleDrag);
        document.addEventListener('touchend', stopDrag);
      }

      function handleDrag(e) {
        if (!isDragging) return;
        e.preventDefault();

        var clientX = e.clientX || (e.touches && e.touches[0].clientX);
        if (!clientX) return;

        var rect = element.getBoundingClientRect();
        var deltaX = clientX - startX;
        var deltaPercent = (deltaX / rect.width) * 100;
        var newPercentage = startLeft + deltaPercent;

        updatePosition(newPercentage);
      }

      function stopDrag() {
        if (!isDragging) return;

        isDragging = false;
        handle.classList.remove('noUi-active');

        triggerEvent('change', [percentageToValue(currentPercentage)]);
        triggerEvent('end', [percentageToValue(currentPercentage)]);

        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', handleDrag);
        document.removeEventListener('touchend', stopDrag);
      }

      var startValue = Array.isArray(currentOptions.start) ? currentOptions.start[0] : currentOptions.start;
      currentPercentage = valueToPercentage(startValue);
      updatePosition(currentPercentage);

      element.addEventListener('click', handleClick);
      handle.addEventListener('mousedown', startDrag);
      handle.addEventListener('touchstart', startDrag);

      var slider = {
        element: element,
        options: currentOptions,

        updateOptions: function(newOptions) {
          Object.assign(currentOptions, newOptions);

          if (newOptions.start !== undefined) {
            var startValue = Array.isArray(newOptions.start) ? newOptions.start[0] : newOptions.start;
            currentPercentage = valueToPercentage(startValue);
            updatePosition(currentPercentage);
          }

          if (newOptions.range) {
            currentPercentage = valueToPercentage(percentageToValue(currentPercentage));
            updatePosition(currentPercentage);
          }

          return this;
        },

        on: function(event, callback) {
          if (!listeners[event]) {
            listeners[event] = [];
          }
          listeners[event].push(callback);
          return this;
        },

        off: function(event, callback) {
          if (listeners[event]) {
            listeners[event] = listeners[event].filter(function(cb) {
              return cb !== callback;
            });
          }
          return this;
        },

        destroy: function() {
          element.removeEventListener('click', handleClick);
          handle.removeEventListener('mousedown', startDrag);
          handle.removeEventListener('touchstart', startDrag);

          document.removeEventListener('mousemove', handleDrag);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', handleDrag);
          document.removeEventListener('touchend', stopDrag);

          element.innerHTML = '';
          listeners = {};
        },

        get: function() {
          return [percentageToValue(currentPercentage)];
        },

        set: function(value) {
          var val = Array.isArray(value) ? value[0] : value;
          var percentage = valueToPercentage(val);
          updatePosition(percentage);
          triggerEvent('set', [val]);
        }
      };

      element.noUiSlider = slider;

      return slider;
    }
  };

  return noUiSlider;

}));
